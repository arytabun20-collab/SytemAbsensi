<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absen Otomatis</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
    (function(){
        emailjs.init({ publicKey: "ziS95MemIgRkjCG3l" }); 
    })();
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        #halaman-daftar, #halaman-absen, #halaman-admin, #modal-konfirmasi, #modal-mahasiswa { display: none; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-12">

    <div class="container mx-auto p-4 max-w-6xl w-full">

        <div id="halaman-login" class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Login Akun</h1>
            <form id="form-login">
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">Alamat Email</label>
                    <input type="email" id="login-email" name="email" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" placeholder="contoh@email.com">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="login-password" name="password" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" placeholder="******************">
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full">Login</button>
                <div class="text-center mt-4">
                    <button type="button" id="link-ke-daftar" class="text-sm text-gray-500 hover:text-blue-600 underline">Belum punya akun? Daftar di sini</button>
                </div>
            </form>
        </div>
        
        <div id="halaman-daftar" class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Daftar Akun Baru</h1>
            <form id="form-daftar">
                <div class="mb-4">
                    <label for="daftar-email" class="block text-gray-700 text-sm font-bold mb-2">Alamat Email</label>
                    <input type="email" id="daftar-email" name="email" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" placeholder="contoh@email.com">
                </div>
                <div class="mb-6">
                    <label for="daftar-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="daftar-password" name="password" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" placeholder="Buat password Anda">
                </div>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full">Daftar</button>
                <div class="text-center mt-4">
                    <button type="button" id="link-ke-login" class="text-sm text-gray-500 hover:text-blue-600 underline">Sudah punya akun? Login di sini</button>
                </div>
            </form>
        </div>

        <div id="halaman-absen" class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Form Absensi Mahasiswa</h1>
                <p class="text-gray-600 mt-2">Program Studi Pendidikan Teknik Elektro</p>
            </div>
            <form id="form-absen" novalidate>
                <div class="mb-4"><label for="nama" class="block text-sm font-bold text-gray-700 mb-2">Nama Lengkap</label><input type="text" id="nama" required class="shadow-sm border rounded w-full py-2 px-3 text-gray-700"></div>
                <div class="mb-4"><label for="nim" class="block text-sm font-bold text-gray-700 mb-2">Nomor Induk Mahasiswa</label><input type="text" id="nim" required class="shadow-sm border rounded w-full py-2 px-3 text-gray-700"></div>
                <div class="mb-4"><label for="kampus" class="block text-sm font-bold text-gray-700 mb-2">Nama Kampus</label><input type="text" id="kampus" required class="shadow-sm border rounded w-full py-2 px-3 text-gray-700"></div>
                <div class="mb-6"><label for="foto" class="block text-sm font-bold text-gray-700 mb-2">Upload Foto Bukti</label><input type="file" id="foto" required accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
                <div class="mt-6"><button type="submit" id="btn-kirim-absen" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg w-full">Kirim Absensi</button></div>
                <div class="text-center mt-6"><button type="button" id="btn-logout" class="text-sm text-gray-500 hover:text-blue-600 underline">Logout</button></div>
            </form>
        </div>
        
        <div id="halaman-admin" class="bg-white p-8 rounded-xl shadow-lg w-full">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Dashboard Laporan Absensi</h1>
                <div class="flex items-center space-x-4">
                    <button id="btn-lihat-mahasiswa" class="text-sm text-blue-600 hover:text-blue-800 underline">Daftar Mahasiswa (Soon)</button>
                    <button id="btn-admin-logout" class="text-sm text-gray-500 hover:text-blue-600 underline">Logout</button>
                </div>
            </div>
            <p class="text-gray-600 mb-4">Berikut adalah daftar seluruh absensi mahasiswa. Data akan ter-update secara otomatis.</p>
            
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                        <tr>
                            <th class="py-3 px-4 text-left">No.</th>
                            <th class="py-3 px-4 text-left">Nama</th>
                            <th class="py-3 px-4 text-left">NIM</th>
                            <th class="py-3 px-4 text-center">Foto</th>
                            <th class="py-3 px-4 text-left">Tanggal Kirim</th>
                            <th class="py-3 px-4 text-left">Waktu Masuk</th>
                            <th class="py-3 px-4 text-left">Waktu Pulang</th>
                            <th class="py-3 px-4 text-left">Status</th>
                            <th class="py-3 px-4 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabel-laporan-body" class="text-gray-700 text-sm font-medium"></tbody>
                </table>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="btn-kirim-laporan-email" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Kirim Laporan ke Email</button>
            </div>
        </div>
    </div>

    <div id="modal-konfirmasi" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg text-center max-w-sm w-full">
            <h2 id="modal-judul" class="text-2xl font-bold mb-4"></h2>
            <p id="pesan-modal" class="text-gray-700 mb-6"></p>
            <button id="tombol-tutup-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Tutup</button>
        </div>
    </div>

    <div id="modal-mahasiswa" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Mahasiswa Terdaftar</h2>
                <button id="tombol-tutup-modal-mahasiswa" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="overflow-y-auto max-h-96 rounded-lg border border-gray-200">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-sm sticky top-0">
                        <tr><th class="py-3 px-6 text-left">No.</th><th class="py-3 px-6 text-left">Alamat Email</th><th class="py-3 px-6 text-center">Aksi</th></tr>
                    </thead>
                    <tbody id="tabel-mahasiswa-body" class="text-gray-700 text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // GANTI DENGAN KODE KONFIGURASI DARI PROYEK FIREBASE ANDA
        const firebaseConfig = {
          apiKey: "AIzaSy...GANTI-DENGAN-API-KEY-ANDA",
          authDomain: "proyek-anda.firebaseapp.com",
          projectId: "proyek-anda",
          storageBucket: "proyek-anda.appspot.com",
          messagingSenderId: "GANTI-DENGAN-SENDER-ID-ANDA",
          appId: "GANTI-DENGAN-APP-ID-ANDA"
        };
        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // --- Elemen DOM ---
        const halamanLogin = document.getElementById('halaman-login');
        const halamanDaftar = document.getElementById('halaman-daftar');
        const halamanAbsen = document.getElementById('halaman-absen');
        const halamanAdmin = document.getElementById('halaman-admin');
        const formLogin = document.getElementById('form-login');
        const formDaftar = document.getElementById('form-daftar');
        const formAbsen = document.getElementById('form-absen');
        const linkKeDaftar = document.getElementById('link-ke-daftar');
        const linkKeLogin = document.getElementById('link-ke-login');
        const btnLogout = document.getElementById('btn-logout');
        const btnAdminLogout = document.getElementById('btn-admin-logout');
        const btnKirimLaporanEmail = document.getElementById('btn-kirim-laporan-email');
        const tabelLaporanBody = document.getElementById('tabel-laporan-body');
        const modalKonfirmasi = document.getElementById('modal-konfirmasi');
        const modalJudul = document.getElementById('modal-judul');
        const pesanModal = document.getElementById('pesan-modal');
        const tombolTutupModal = document.getElementById('tombol-tutup-modal');
        const btnLihatMahasiswa = document.getElementById('btn-lihat-mahasiswa');
        const modalMahasiswa = document.getElementById('modal-mahasiswa');
        const tabelMahasiswaBody = document.getElementById('tabel-mahasiswa-body');
        const tombolTutupModalMahasiswa = document.getElementById('tombol-tutup-modal-mahasiswa');

        // --- Konfigurasi ---
        const ADMIN_EMAIL = 'admin@pte.com';
        const ADMIN_PASSWORD = 'admin123';
        const EMAIL_ADMIN_TUJUAN = 'arytabun10@gmail.com';

        // --- Fungsi Helper & Navigasi ---
        const tampilkanModal = (judul, pesan, isError = false) => {
            modalJudul.textContent = judul;
            pesanModal.innerHTML = pesan; 
            modalJudul.className = `text-2xl font-bold mb-4 ${isError ? 'text-red-600' : 'text-green-600'}`;
            modalKonfirmasi.style.display = 'flex';
        };
        const goToHalamanLogin = () => {
            halamanAbsen.style.display = 'none';
            halamanAdmin.style.display = 'none';
            halamanDaftar.style.display = 'none';
            halamanLogin.style.display = 'block';
        };
        const goToAbsenPage = () => {
            halamanLogin.style.display = 'none';
            halamanDaftar.style.display = 'none';
            halamanAdmin.style.display = 'none';
            halamanAbsen.style.display = 'block';
        };
        const goToAdminPage = () => {
            halamanLogin.style.display = 'none';
            halamanDaftar.style.display = 'none';
            halamanAbsen.style.display = 'none';
            halamanAdmin.style.display = 'block';
            tampilkanLaporanAbsensi(); 
        };

        // --- Cek Status Login Saat Halaman Dimuat ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // Jika user adalah admin, langsung ke halaman admin
                if (user.email === ADMIN_EMAIL) {
                    goToAdminPage();
                } else {
                // Jika user adalah mahasiswa, ke halaman absen
                    goToAbsenPage();
                }
            } else {
                // Jika tidak ada user, tampilkan halaman login
                goToHalamanLogin();
            }
        });

        // --- Event Listener ---
        linkKeDaftar.addEventListener('click', () => { halamanLogin.style.display = 'none'; halamanDaftar.style.display = 'block'; });
        linkKeLogin.addEventListener('click', () => { halamanDaftar.style.display = 'none'; halamanLogin.style.display = 'block'; });
        
        btnLogout.addEventListener('click', () => auth.signOut());
        btnAdminLogout.addEventListener('click', () => auth.signOut());

        tombolTutupModal.addEventListener('click', () => { modalKonfirmasi.style.display = 'none'; });
        // btnLihatMahasiswa.addEventListener('click', tampilkanDaftarMahasiswa); // Sementara dinonaktifkan
        tombolTutupModalMahasiswa.addEventListener('click', () => { modalMahasiswa.style.display = 'none'; });

        // --- LOGIKA FIREBASE ---
        
        // Pendaftaran Akun
        formDaftar.addEventListener('submit', (event) => {
            event.preventDefault();
            const email = document.getElementById('daftar-email').value;
            const password = document.getElementById('daftar-password').value;
            if (!email || !password) { tampilkanModal('Gagal', 'Email dan password tidak boleh kosong.', true); return; }
            if (email === ADMIN_EMAIL) { tampilkanModal('Registrasi Gagal', 'Email ini khusus untuk admin.', true); return; }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    tampilkanModal('Registrasi Berhasil', `Akun untuk ${email} telah dibuat.`);
                    formDaftar.reset();
                    goToHalamanLogin();
                })
                .catch((error) => {
                    tampilkanModal('Registrasi Gagal', error.message, true);
                });
        });

        // Login Akun
        formLogin.addEventListener('submit', (event) => {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    tampilkanModal('Login Gagal', 'Email atau password salah.', true);
                });
        });

        // Kirim Absensi
        formAbsen.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!formAbsen.checkValidity()) { formAbsen.reportValidity(); return; }
            const nama = document.getElementById('nama').value;
            const nim = document.getElementById('nim').value;
            const kampus = document.getElementById('kampus').value;
            const foto = document.getElementById('foto').files[0];
            const btnKirim = document.getElementById('btn-kirim-absen');
            
            const currentUser = auth.currentUser;

            if (!currentUser) {
                tampilkanModal('Gagal', 'Sesi Anda telah berakhir, silakan login kembali.', true);
                return;
            }
            if (!foto) {
                tampilkanModal('Gagal', 'Silakan upload foto bukti.', true);
                return;
            }

            btnKirim.disabled = true;
            btnKirim.textContent = 'Mengunggah...';

            // 1. Upload foto ke Firebase Storage
            const filePath = `bukti/${currentUser.uid}/${Date.now()}_${foto.name}`;
            const storageRef = storage.ref(filePath);
            const uploadTask = storageRef.put(foto);

            uploadTask.on('state_changed', 
                (snapshot) => { /* bisa tambahkan progress bar di sini */ }, 
                (error) => { // Handle unsuccessful uploads
                    console.error("Upload failed: ", error);
                    tampilkanModal('Upload Gagal', 'Gagal mengunggah foto.', true);
                    btnKirim.disabled = false;
                    btnKirim.textContent = 'Kirim Absensi';
                }, 
                () => { // Handle successful uploads on complete
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        // 2. Simpan data ke Firestore setelah foto berhasil diupload
                        db.collection("absensi").add({
                            nama: nama,
                            nim: nim,
                            kampus: kampus,
                            fotoUrl: downloadURL, // Gunakan URL dari Firebase Storage
                            waktuKirim: firebase.firestore.FieldValue.serverTimestamp(),
                            waktuMasuk: new Date().toTimeString().slice(0, 5),
                            waktuPulang: '',
                            status: 'Hadir',
                            emailMahasiswa: currentUser.email
                        })
                        .then(() => {
                            tampilkanModal('Absensi Terkirim', 'Data Anda telah berhasil disimpan.');
                            formAbsen.reset();
                        })
                        .catch((error) => {
                            tampilkanModal('Gagal Menyimpan', 'Gagal menyimpan data absensi: ' + error.message, true);
                        })
                        .finally(() => {
                            btnKirim.disabled = false;
                            btnKirim.textContent = 'Kirim Absensi';
                        });
                    });
                }
            );
        });

        // Tampilkan Laporan Admin (Real-time)
        function tampilkanLaporanAbsensi() {
            db.collection("absensi").orderBy("waktuKirim", "desc").onSnapshot((querySnapshot) => {
                tabelLaporanBody.innerHTML = '';
                if (querySnapshot.empty) {
                    tabelLaporanBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500">Belum ada data absensi.</td></tr>`;
                    return;
                }

                let allDataForEmail = []; // Siapkan array untuk data email

                querySnapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const id = doc.id;
                    allDataForEmail.push(data); // Tambahkan data ke array

                    const waktuKirimObj = data.waktuKirim ? data.waktuKirim.toDate() : new Date();
                    const waktuKirimFormatted = waktuKirimObj.toLocaleDateString('id-ID', {day: '2-digit', month: 'short', year: 'numeric'}) + ' ' + waktuKirimObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4">${index + 1}</td>
                        <td class="py-3 px-4">${data.nama}</td>
                        <td class="py-3 px-4">${data.nim}</td>
                        <td class="py-3 px-4 text-center"><a href="${data.fotoUrl}" target="_blank"><img src="${data.fotoUrl}" class="h-12 w-12 object-cover rounded-md mx-auto cursor-pointer"></a></td>
                        <td class="py-3 px-4">${waktuKirimFormatted}</td>
                        <td class="py-3 px-4"><input type="time" class="border rounded px-2 py-1 w-full" value="${data.waktuMasuk || ''}" onchange="simpanPerubahan('${id}', 'waktuMasuk', this.value)"></td>
                        <td class="py-3 px-4"><input type="time" class="border rounded px-2 py-1 w-full" value="${data.waktuPulang || ''}" onchange="simpanPerubahan('${id}', 'waktuPulang', this.value)"></td>
                        <td class="py-3 px-4"><select class="border rounded px-2 py-1 w-full" onchange="simpanPerubahan('${id}', 'status', this.value)">${buatOpsiStatus(data.status)}</select></td>
                        <td class="py-3 px-4 text-center"><button class="bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded" onclick="hapusAbsensi('${id}', '${data.fotoUrl}')">Hapus</button></td>
                    `;
                    tabelLaporanBody.appendChild(row);
                });

                // Simpan data terbaru ke variabel global untuk fungsi email
                window.laporanAbsensiGlobal = allDataForEmail;

            }, (error) => {
                console.error("Error fetching data: ", error);
                tampilkanModal('Error', 'Gagal memuat data dari database.', true);
            });
        }
        
        // Fungsi baru untuk simpan perubahan ke Firestore
        function simpanPerubahan(id, field, value) {
            db.collection("absensi").doc(id).update({ [field]: value })
                .catch(error => console.error("Error updating document: ", error));
        }

        // Fungsi hapus yang diperbarui untuk hapus data & foto
        function hapusAbsensi(id, fotoUrl) {
            if (confirm('Anda yakin ingin menghapus data absensi ini?')) {
                // Hapus dokumen dari Firestore
                db.collection("absensi").doc(id).delete()
                    .then(() => {
                        // Jika ada foto, hapus juga dari Storage
                        if (fotoUrl) {
                            const fotoRef = storage.refFromURL(fotoUrl);
                            fotoRef.delete().catch(error => {
                                if (error.code === 'storage/object-not-found') {
                                    console.log("Foto sudah tidak ada, lanjut.");
                                } else {
                                    console.error("Gagal hapus foto: ", error);
                                }
                            });
                        }
                    })
                    .catch((error) => {
                        console.error("Error removing document: ", error);
                        tampilkanModal('Gagal', 'Gagal menghapus data.', true);
                    });
            }
        }

        function buatOpsiStatus(statusTersimpan) {
            const opsi = ['Hadir', 'Sakit', 'Izin', 'Alpa'];
            return opsi.map(opt => `<option value="${opt}" ${opt === statusTersimpan ? 'selected' : ''}>${opt}</option>`).join('');
        }
        
        // Fungsi Kirim Laporan via Email (menggunakan data dari Firebase)
        btnKirimLaporanEmail.addEventListener('click', () => {
            const absensiData = window.laporanAbsensiGlobal || [];

            if (absensiData.length === 0) {
                tampilkanModal('Gagal', `Tidak ada data untuk dikirim.`, true);
                return;
            }
            
            let tabelHtml = `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;"><thead><tr style="background-color: #f2f2f2;"><th>No.</th><th>Nama</th><th>NIM</th><th>Kampus</th><th>Tanggal</th><th>Waktu Masuk</th><th>Waktu Pulang</th><th>Status</th></tr></thead><tbody>`;
            absensiData.forEach((data, index) => {
                const tanggalKirim = data.waktuKirim ? data.waktuKirim.toDate().toLocaleDateString('id-ID') : 'N/A';
                tabelHtml += `<tr><td>${index + 1}</td><td>${data.nama}</td><td>${data.nim}</td><td>${data.kampus}</td><td>${tanggalKirim}</td><td>${data.waktuMasuk || '-'}</td><td>${data.waktuPulang || '-'}</td><td>${data.status || '-'}</td></tr>`;
            });
            tabelHtml += `</tbody></table>`;

            const dataForCsv = absensiData.map((data, index) => ({
                'No.': index + 1, 
                'Nama Mahasiswa': data.nama, 
                'NIM': data.nim, 
                'Kampus': data.kampus,
                'Tanggal': data.waktuKirim ? data.waktuKirim.toDate().toLocaleDateString('id-ID') : 'N/A',
                'Waktu Masuk': data.waktuMasuk || '', 
                'Waktu Pulang': data.waktuPulang || '', 
                'Status': data.status
            }));
            const csvString = Papa.unparse(dataForCsv);
            const encodedUri = encodeURI(`data:text/csv;charset=utf-8,${csvString}`);
            const linkDownload = `<a href="${encodedUri}" download="laporan_absensi.csv" style="background-color:#28a745;color:white;padding:10px 15px;text-decoration:none;border-radius:5px;">Download Laporan (CSV)</a>`;

            const templateParams = {
                to_email: EMAIL_ADMIN_TUJUAN,
                tanggal_laporan: "Laporan Absensi Keseluruhan",
                laporan_html: tabelHtml,
                link_download_csv: linkDownload
            };
            
            tampilkanModal('Mengirim...', 'Sedang mempersiapkan laporan...');
            emailjs.send('service_crd8v2r', 'template_k3jmrfv', templateParams)
                .then(() => { tampilkanModal('Sukses', `Laporan telah dikirim ke ${EMAIL_ADMIN_TUJUAN}.`); }, 
                      (error) => { tampilkanModal('Gagal', 'Terjadi kesalahan saat mengirim email.', true); console.log('EMAIL FAILED...', error); });
        });

    </script>
</body>
</html>

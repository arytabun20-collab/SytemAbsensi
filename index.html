
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absen Otomatis</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
    (function(){
        emailjs.init({ publicKey: "ziS95MemIgRkjCG3l" }); 
    })();
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        #halaman-daftar, #halaman-absen, #halaman-admin, #modal-konfirmasi, #modal-mahasiswa { display: none; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-12">

    <div class="container mx-auto p-4 max-w-6xl w-full">

        <div id="halaman-login" class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Login Akun</h1>
            <form id="form-login">
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">Alamat Email</label>
                    <input type="email" id="login-email" name="email" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" placeholder="contoh@email.com">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="login-password" name="password" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" placeholder="******************">
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full">Login</button>
                <div class="text-center mt-4">
                    <button type="button" id="link-ke-daftar" class="text-sm text-gray-500 hover:text-blue-600 underline">Belum punya akun? Daftar di sini</button>
                </div>
            </form>
        </div>
        
        <div id="halaman-daftar" class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Daftar Akun Baru</h1>
            <form id="form-daftar">
                <div class="mb-4">
                    <label for="daftar-email" class="block text-gray-700 text-sm font-bold mb-2">Alamat Email</label>
                    <input type="email" id="daftar-email" name="email" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" placeholder="contoh@email.com">
                </div>
                <div class="mb-6">
                    <label for="daftar-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="daftar-password" name="password" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" placeholder="Buat password Anda">
                </div>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full">Daftar</button>
                <div class="text-center mt-4">
                    <button type="button" id="link-ke-login" class="text-sm text-gray-500 hover:text-blue-600 underline">Sudah punya akun? Login di sini</button>
                </div>
            </form>
        </div>

        <div id="halaman-absen" class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Form Absensi Mahasiswa</h1>
                <p class="text-gray-600 mt-2">Program Studi Pendidikan Teknik Elektro</p>
            </div>
            <form id="form-absen" novalidate>
                <div class="mb-4"><label for="nama" class="block text-sm font-bold text-gray-700 mb-2">Nama Lengkap</label><input type="text" id="nama" required class="shadow-sm border rounded w-full py-2 px-3 text-gray-700"></div>
                <div class="mb-4"><label for="nim" class="block text-sm font-bold text-gray-700 mb-2">Nomor Induk Mahasiswa</label><input type="text" id="nim" required class="shadow-sm border rounded w-full py-2 px-3 text-gray-700"></div>
                <div class="mb-4"><label for="kampus" class="block text-sm font-bold text-gray-700 mb-2">Nama Kampus</label><input type="text" id="kampus" required class="shadow-sm border rounded w-full py-2 px-3 text-gray-700"></div>
                <div class="mb-6"><label for="foto" class="block text-sm font-bold text-gray-700 mb-2">Upload Foto Bukti</label><input type="file" id="foto" required accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
                <div class="mt-6"><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg w-full">Kirim Absensi ke Admin</button></div>
                <div class="text-center mt-6"><button type="button" id="btn-logout" class="text-sm text-gray-500 hover:text-blue-600 underline">Logout</button></div>
            </form>
        </div>
        
        <div id="halaman-admin" class="bg-white p-8 rounded-xl shadow-lg w-full">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Dashboard Laporan Absensi</h1>
                <div class="flex items-center space-x-4">
                    <button id="btn-lihat-mahasiswa" class="text-sm text-blue-600 hover:text-blue-800 underline">Daftar Mahasiswa</button>
                    <button id="btn-admin-logout" class="text-sm text-gray-500 hover:text-blue-600 underline">Logout</button>
                </div>
            </div>
            <p class="text-gray-600 mb-4">Berikut adalah daftar seluruh absensi mahasiswa. Anda dapat mengubah waktu dan status secara manual.</p>
            
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                        <tr>
                            <th class="py-3 px-4 text-left">No.</th>
                            <th class="py-3 px-4 text-left">Nama</th>
                            <th class="py-3 px-4 text-left">NIM</th>
                            <th class="py-3 px-4 text-center">Foto</th>
                            <th class="py-3 px-4 text-left">Tanggal Kirim</th>
                            <th class="py-3 px-4 text-left">Waktu Masuk</th>
                            <th class="py-3 px-4 text-left">Waktu Pulang</th>
                            <th class="py-3 px-4 text-left">Status</th>
                            <th class="py-3 px-4 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabel-laporan-body" class="text-gray-700 text-sm font-medium"></tbody>
                </table>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="btn-kirim-laporan-email" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Kirim Laporan ke Email</button>
            </div>
        </div>
        </div>

    <div id="modal-konfirmasi" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg text-center max-w-sm w-full">
            <h2 id="modal-judul" class="text-2xl font-bold mb-4"></h2>
            <p id="pesan-modal" class="text-gray-700 mb-6"></p>
            <button id="tombol-tutup-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Tutup</button>
        </div>
    </div>

    <div id="modal-mahasiswa" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Mahasiswa Terdaftar</h2>
                <button id="tombol-tutup-modal-mahasiswa" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="overflow-y-auto max-h-96 rounded-lg border border-gray-200">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-sm sticky top-0">
                        <tr><th class="py-3 px-6 text-left">No.</th><th class="py-3 px-6 text-left">Alamat Email</th><th class="py-3 px-6 text-center">Aksi</th></tr>
                    </thead>
                    <tbody id="tabel-mahasiswa-body" class="text-gray-700 text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Elemen DOM ---
        const halamanLogin = document.getElementById('halaman-login');
        const halamanDaftar = document.getElementById('halaman-daftar');
        const halamanAbsen = document.getElementById('halaman-absen');
        const halamanAdmin = document.getElementById('halaman-admin');
        const formLogin = document.getElementById('form-login');
        const formDaftar = document.getElementById('form-daftar');
        const formAbsen = document.getElementById('form-absen');
        const linkKeDaftar = document.getElementById('link-ke-daftar');
        const linkKeLogin = document.getElementById('link-ke-login');
        const btnLogout = document.getElementById('btn-logout');
        const btnAdminLogout = document.getElementById('btn-admin-logout');
        const btnKirimLaporanEmail = document.getElementById('btn-kirim-laporan-email');
        const tabelLaporanBody = document.getElementById('tabel-laporan-body');
        const modalKonfirmasi = document.getElementById('modal-konfirmasi');
        const modalJudul = document.getElementById('modal-judul');
        const pesanModal = document.getElementById('pesan-modal');
        const tombolTutupModal = document.getElementById('tombol-tutup-modal');
        const btnLihatMahasiswa = document.getElementById('btn-lihat-mahasiswa');
        const modalMahasiswa = document.getElementById('modal-mahasiswa');
        const tabelMahasiswaBody = document.getElementById('tabel-mahasiswa-body');
        const tombolTutupModalMahasiswa = document.getElementById('tombol-tutup-modal-mahasiswa');
        // Variabel filterTanggal dan btnResetData dihapus

        // --- Konfigurasi ---
        const ADMIN_EMAIL = 'admin@pte.com';
        const ADMIN_PASSWORD = 'admin123';
        const EMAIL_ADMIN_TUJUAN = 'arytabun10@gmail.com';

        // --- Fungsi Helper & Navigasi ---
        const tampilkanModal = (judul, pesan, isError = false) => {
            modalJudul.textContent = judul;
            pesanModal.innerHTML = pesan; 
            modalJudul.className = `text-2xl font-bold mb-4 ${isError ? 'text-red-600' : 'text-green-600'}`;
            modalKonfirmasi.style.display = 'flex';
        };
        const goToHalamanLogin = () => {
            halamanAbsen.style.display = 'none';
            halamanAdmin.style.display = 'none';
            halamanDaftar.style.display = 'none';
            halamanLogin.style.display = 'block';
        };
        const goToAbsenPage = () => {
            halamanLogin.style.display = 'none';
            halamanDaftar.style.display = 'none';
            halamanAdmin.style.display = 'none';
            halamanAbsen.style.display = 'block';
        };
        // Fungsi goToAdminPage diubah
        const goToAdminPage = () => {
            halamanLogin.style.display = 'none';
            halamanDaftar.style.display = 'none';
            halamanAbsen.style.display = 'none';
            halamanAdmin.style.display = 'block';
            tampilkanLaporanAbsensi(); // Langsung tampilkan laporan tanpa set tanggal
        };

        // --- Event Listener ---
        linkKeDaftar.addEventListener('click', () => { halamanLogin.style.display = 'none'; halamanDaftar.style.display = 'block'; });
        linkKeLogin.addEventListener('click', () => { halamanDaftar.style.display = 'none'; halamanLogin.style.display = 'block'; });
        btnLogout.addEventListener('click', goToHalamanLogin);
        btnAdminLogout.addEventListener('click', goToHalamanLogin);
        tombolTutupModal.addEventListener('click', () => { modalKonfirmasi.style.display = 'none'; });
        btnLihatMahasiswa.addEventListener('click', tampilkanDaftarMahasiswa);
        tombolTutupModalMahasiswa.addEventListener('click', () => { modalMahasiswa.style.display = 'none'; });
        // Event listener untuk filterTanggal dan btnResetData dihapus

        // --- Logika Registrasi & Login ---
        formDaftar.addEventListener('submit', (event) => {
            event.preventDefault();
            const email = document.getElementById('daftar-email').value;
            const password = document.getElementById('daftar-password').value;
            if (!email || !password) { tampilkanModal('Gagal', 'Email dan password kosong.', true); return; }
            if (email === ADMIN_EMAIL) { tampilkanModal('Registrasi Gagal', 'Email ini untuk admin.', true); return; }
            let userCredentials = JSON.parse(localStorage.getItem('user_credentials')) || {};
            if (userCredentials[email]) {
                tampilkanModal('Registrasi Gagal', 'Email sudah terdaftar.', true);
            } else {
                userCredentials[email] = password;
                localStorage.setItem('user_credentials', JSON.stringify(userCredentials));
                tampilkanModal('Registrasi Berhasil', `Akun untuk ${email} telah dibuat.`);
                goToHalamanLogin();
            }
        });
        formLogin.addEventListener('submit', (event) => {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) { goToAdminPage(); return; }
            let userCredentials = JSON.parse(localStorage.getItem('user_credentials')) || {};
            if (userCredentials[email] && userCredentials[email] === password) { goToAbsenPage(); } 
            else { tampilkanModal('Login Gagal', 'Email atau password salah.', true); }
        });

        // --- Logika Absensi Mahasiswa ---
        formAbsen.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!formAbsen.checkValidity()) { formAbsen.reportValidity(); return; }
            const nama = document.getElementById('nama').value;
            const nim = document.getElementById('nim').value;
            const kampus = document.getElementById('kampus').value;
            const foto = document.getElementById('foto').files[0];
            const reader = new FileReader();
            reader.readAsDataURL(foto);
            reader.onloadend = function() {
                const waktuSekarang = new Date();
                const newSubmission = {
                    nama: nama, nim: nim, kampus: kampus, fotoBase64: reader.result,
                    waktu: waktuSekarang.toISOString(),
                    waktuMasuk: waktuSekarang.toTimeString().slice(0, 5),
                    waktuPulang: '',
                    status: 'Hadir'
                };
                let absensiData = JSON.parse(localStorage.getItem('absensi_data')) || [];
                absensiData.push(newSubmission);
                localStorage.setItem('absensi_data', JSON.stringify(absensiData));
                tampilkanModal('Absensi Terkirim', 'Data Anda telah disimpan.');
                formAbsen.reset();
            }
        });

        // --- Logika Halaman Admin (DIUBAH) ---
        function tampilkanLaporanAbsensi() {
            // Logika filter berdasarkan tanggal dihapus
            const absensiData = JSON.parse(localStorage.getItem('absensi_data')) || [];

            tabelLaporanBody.innerHTML = '';
            if (absensiData.length === 0) {
                // Pesan diubah menjadi lebih umum
                tabelLaporanBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500">Tidak ada data absensi.</td></tr>`;
                return;
            }
            
            // Mengurutkan data dari yang terbaru ke terlama
            absensiData.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));

            absensiData.forEach((data, index) => {
                const waktuKirimObj = new Date(data.waktu);
                // Menampilkan tanggal dan waktu kirim
                const waktuKirimFormatted = waktuKirimObj.toLocaleDateString('id-ID', {day: '2-digit', month: 'short', year: 'numeric'}) + ' ' + waktuKirimObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                // index yang digunakan untuk fungsi hapus, simpan, dll. tetap index asli dari array
                row.innerHTML = `
                    <td class="py-3 px-4">${index + 1}</td>
                    <td class="py-3 px-4">${data.nama}</td>
                    <td class="py-3 px-4">${data.nim}</td>
                    <td class="py-3 px-4 text-center"><img src="${data.fotoBase64}" class="h-12 w-12 object-cover rounded-md mx-auto cursor-pointer" onclick="tampilkanModal('Foto Bukti', '<img src=\\'${data.fotoBase64}\\' class=\\'w-full h-auto rounded-lg\\'>')"></td>
                    <td class="py-3 px-4">${waktuKirimFormatted}</td>
                    <td class="py-3 px-4"><input type="time" class="border rounded px-2 py-1 w-full" value="${data.waktuMasuk || ''}" onchange="simpanWaktu(${index}, 'waktuMasuk', this.value)"></td>
                    <td class="py-3 px-4"><input type="time" class="border rounded px-2 py-1 w-full" value="${data.waktuPulang || ''}" onchange="simpanWaktu(${index}, 'waktuPulang', this.value)"></td>
                    <td class="py-3 px-4"><select class="border rounded px-2 py-1 w-full" onchange="simpanStatus(${index}, this.value)">${buatOpsiStatus(data.status)}</select></td>
                    <td class="py-3 px-4 text-center"><button class="bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded" onclick="hapusAbsensi(${index})">Hapus</button></td>
                `;
                tabelLaporanBody.appendChild(row);
            });
        }
        
        function buatOpsiStatus(statusTersimpan) {
            const opsi = ['Hadir', 'Sakit', 'Izin', 'Alpa'];
            return opsi.map(opt => `<option value="${opt}" ${opt === statusTersimpan ? 'selected' : ''}>${opt}</option>`).join('');
        }
        function simpanStatus(index, status) {
            let absensiData = JSON.parse(localStorage.getItem('absensi_data')) || [];
            absensiData.sort((a, b) => new Date(b.waktu) - new Date(a.waktu)); // Pastikan urutan sama
            if (absensiData[index]) { absensiData[index].status = status; localStorage.setItem('absensi_data', JSON.stringify(absensiData)); }
        }
        function simpanWaktu(index, tipeWaktu, nilai) {
            let absensiData = JSON.parse(localStorage.getItem('absensi_data')) || [];
            absensiData.sort((a, b) => new Date(b.waktu) - new Date(a.waktu)); // Pastikan urutan sama
            if (absensiData[index]) { absensiData[index][tipeWaktu] = nilai; localStorage.setItem('absensi_data', JSON.stringify(absensiData)); }
        }
        function hapusAbsensi(index) {
            if (confirm('Anda yakin ingin menghapus data absensi ini?')) {
                let absensiData = JSON.parse(localStorage.getItem('absensi_data')) || [];
                absensiData.sort((a, b) => new Date(b.waktu) - new Date(a.waktu)); // Pastikan urutan sama
                absensiData.splice(index, 1);
                localStorage.setItem('absensi_data', JSON.stringify(absensiData));
                tampilkanLaporanAbsensi();
            }
        }
        function tampilkanDaftarMahasiswa() {
            const userCredentials = JSON.parse(localStorage.getItem('user_credentials')) || {};
            tabelMahasiswaBody.innerHTML = '';
            const mahasiswaEmails = Object.keys(userCredentials).filter(email => email !== ADMIN_EMAIL);
            if (mahasiswaEmails.length === 0) {
                tabelMahasiswaBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada mahasiswa terdaftar.</td></tr>';
            } else {
                mahasiswaEmails.forEach((email, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200';
                    row.innerHTML = `<td class="py-3 px-6">${index + 1}</td><td class="py-3 px-6">${email}</td><td class="py-3 px-6 text-center"><button class="bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded" onclick="hapusMahasiswa('${email}')">Hapus</button></td>`;
                    tabelMahasiswaBody.appendChild(row);
                });
            }
            modalMahasiswa.style.display = 'flex';
        }
        function hapusMahasiswa(email) {
            if (confirm(`Anda yakin ingin menghapus akun ${email}?`)) {
                let userCredentials = JSON.parse(localStorage.getItem('user_credentials')) || {};
                delete userCredentials[email];
                localStorage.setItem('user_credentials', JSON.stringify(userCredentials));
                tampilkanDaftarMahasiswa();
            }
        }
        
        // Fungsi pengiriman email diubah
        btnKirimLaporanEmail.addEventListener('click', () => {
            const absensiData = JSON.parse(localStorage.getItem('absensi_data')) || [];

            if (absensiData.length === 0) {
                tampilkanModal('Gagal', `Tidak ada data untuk dikirim.`, true);
                return;
            }
            
            // Mengurutkan data sebelum mengirim email
            absensiData.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));
            
            let tabelHtml = `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;"><thead><tr style="background-color: #f2f2f2;"><th>No.</th><th>Nama</th><th>NIM</th><th>Kampus</th><th>Tanggal</th><th>Waktu Masuk</th><th>Waktu Pulang</th><th>Status</th></tr></thead><tbody>`;
            absensiData.forEach((data, index) => {
                const tanggalKirim = new Date(data.waktu).toLocaleDateString('id-ID');
                tabelHtml += `<tr><td>${index + 1}</td><td>${data.nama}</td><td>${data.nim}</td><td>${data.kampus}</td><td>${tanggalKirim}</td><td>${data.waktuMasuk || '-'}</td><td>${data.waktuPulang || '-'}</td><td>${data.status || '-'}</td></tr>`;
            });
            tabelHtml += `</tbody></table>`;

            const dataForCsv = absensiData.map((data, index) => ({
                'No.': index + 1, 'Nama Mahasiswa': data.nama, 'NIM': data.nim, 'Kampus': data.kampus,
                'Tanggal': new Date(data.waktu).toLocaleDateString('id-ID'),
                'Waktu Masuk': data.waktuMasuk || '', 'Waktu Pulang': data.waktuPulang || '', 'Status': data.status
            }));
            const csvString = Papa.unparse(dataForCsv);
            const encodedUri = encodeURI(`data:text/csv;charset=utf-8,${csvString}`);
            const linkDownload = `<a href="${encodedUri}" download="laporan_absensi_keseluruhan.csv" style="background-color:#28a745;color:white;padding:10px 15px;text-decoration:none;border-radius:5px;">Download Laporan</a>`;

            const templateParams = {
                to_email: EMAIL_ADMIN_TUJUAN,
                tanggal_laporan: "Laporan Absensi Keseluruhan", // Judul diubah
                laporan_html: tabelHtml,
                link_download_csv: linkDownload
            };
            
            tampilkanModal('Mengirim...', 'Sedang mempersiapkan laporan...');
            emailjs.send('service_crd8v2r', 'template_k3jmrfv', templateParams)
                .then(() => { tampilkanModal('Sukses', `Laporan terkirim.`); }, 
                      (error) => { tampilkanModal('Gagal', 'Terjadi kesalahan.', true); console.log('EMAIL FAILED...', error); });
        });
    </script>
</body>
</html>